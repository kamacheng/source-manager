# 资源引用检查功能使用指南

## 功能概述

**资源引用检查**是一个用于检测资源引用完整性的工具。它会比对：
- **后台数据库中的资源**（sourceKey 映射表）
- **客户端配置中的引用**（道具、技能、UI 等配置中使用的 sourceKey）

当发现配置引用了已被删除的 sourceKey 时，会给出详细的警告和追溯信息。

## 功能位置

在资源管理后台的顶部导航栏右侧，靠近"操作日志"和"分类管理"按钮的位置有一个 **链接图标** (⛓️)，点击即可启动检查。

```
[资源总数统计] [⛓️ 检查按钮] [📜 操作日志] [⚙️ 分类管理]
```

## 使用流程

### 1. 点击检查按钮
- 点击头部导航栏中的链接图标
- 按钮会进入加载状态（显示旋转的加载器）
- 系统会扫描所有 sourceKey 的引用情况

### 2. 查看检查结果
弹窗会显示三个关键指标：

| 指标 | 说明 |
|------|------|
| 后台资源总数 | 数据库中存在的资源数量 |
| 有效引用总数 | 配置中存在且后台有对应资源的引用数量 |
| 被删除的引用 | 配置中引用的 sourceKey 在后台已被删除的数量 |

### 3. 分析被删除的引用

如果检查发现问题，会列出每个被删除的引用，包括：

**sourceKey**
```
weapon_sword_deprecated_01
```

**应用来源**
- 道具配置 v1.0
- 技能配置 v2.1

**使用详情**
| 道具ID | 用途 |
|--------|------|
| hero_item_001 | 角色头像 |
| weapon_001 | 武器图标 |

## 问题场景示例

### 场景 1: 删除了被使用的资源
```
问题：sourceKey "char_hero_knight" 被删除
引用者：
  - 道具配置 v1.0 中的 hero_item_001（角色头像）
  - UI配置 v3.0 中的 character_display（角色展示）

影响：发布时这些配置的资源绑定会失败
```

### 场景 2: 多个配置引用同一个被删除资源
```
问题：sourceKey "audio_bgm_main_theme" 被删除
引用者：
  - 音频配置 v1.5 中的 bgm_001（背景音乐）
  - 场景配置 v2.0 中的 scene_001（场景音乐）

影响：多个模块的音乐功能会受到影响
```

## 使用建议

### ✅ 删除前的检查流程
1. 确定要删除某个 sourceKey
2. 运行引用检查
3. 如果发现被引用，需要先：
   - 更新所有引用配置，使用新的 sourceKey
   - 或者不删除该 sourceKey（标记为废弃状态）
4. 确认所有引用都已更新后，才能删除

### ✅ 发布前的检查流程
1. 完成所有配置修改
2. 运行引用检查
3. 如果没有被删除的引用，可以安全发布
4. 如果有问题，修复后重新检查

### ⚠️ 注意事项
- 检查结果中的"有效引用"统计帮助你了解各类型资源的使用情况
- 被删除的引用问题需要**立即处理**，否则发布时会报错
- 可以复制检查报告用于文档记录或问题追踪

## 技术细节

### 检查逻辑
```
对于每个客户端配置：
  对于每个引用的 sourceKey：
    IF sourceKey 在后台数据库中 THEN
      计入"有效引用"统计
    ELSE
      记录为"被删除的引用"
      关联该引用的来源配置和使用道具
```

### 数据结构
```javascript
{
  totalResources: 30,           // 后台资源总数
  validReferences: {
    total: 45,
    byType: {
      "角色头像": 5,
      "武器图标": 8,
      "背景音乐": 2,
      // ...
    }
  },
  deletedReferences: [
    {
      sourceKey: "deleted_key",
      sources: ["道具配置 v1.0", "UI配置 v3.0"],
      usageDetails: [
        { itemId: "hero_001", usageType: "角色头像" },
        { itemId: "ui_btn", usageType: "按钮素材" }
      ]
    }
    // ...
  ]
}
```

## 常见问题

### Q: 检查需要多长时间？
A: 通常 1-2 秒，取决于资源和配置的数量。

### Q: 可以导出检查报告吗？
A: 可以，点击"复制报告"按钮将报告复制到剪贴板。

### Q: 删除的引用可以恢复吗？
A: 如果是数据库中的 sourceKey，需要重新上传资源。建议先检查再删除。

### Q: 如何解决被删除的引用问题？
A: 三个方案：
1. **恢复资源**：重新上传相同的 sourceKey
2. **更新配置**：修改配置中的 sourceKey 引用为存在的资源
3. **保留映射**：不删除 sourceKey，但标记为废弃状态

## 后续改进

未来可能添加的功能：
- [ ] 自动修复建议（推荐替代的 sourceKey）
- [ ] 导出详细的引用关系图
- [ ] 设置自动检查提醒
- [ ] 一键更新被删除引用的功能
- [ ] 引用变化历史记录
